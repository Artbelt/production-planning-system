# Перенос на сервер 49.13.143.76

## Что уже сделано в коде

- Добавлен **env.php.example** и загрузка окружения в **auth/includes/config.php** (auth и plan используют DB_HOST, DB_USER, DB_PASS).
- **plan/settings.php**, **plan_U3**, **plan_U4**, **plan_U5/settings.php** читают учётные данные из env.php.
- В **auth/includes/db.php** добавлена функция **getPdo($database)** для единого подключения к БД.
- Часть скриптов (например NP_cut_index.php, NP_build_plan.php) переведена на getPdo('plan_u5').

Часть файлов по-прежнему создаёт PDO с жёстко прописанными root/пустой пароль. Чтобы всё работало на сервере без правки кода, на сервере можно временно создать пользователя root с пустым паролем и выдать права на все базы (небезопасно, только для теста). Либо постепенно переводить остальные скрипты на getPdo() и env.

## Шаги деплоя

### 1. Копирование файлов на сервер

В **PowerShell** из папки `c:\xampp\htdocs`:

```powershell
.\deploy_to_hetzner.ps1
```

Либо вручную (по запросу ввести пароль root):

```powershell
cd c:\xampp\htdocs
scp -o StrictHostKeyChecking=accept-new -r * root@49.13.143.76:/var/www/html/
```

### 2. На сервере: env.php

```bash
ssh root@49.13.143.76
cd /var/www/html
cp env.php.example env.php
nano env.php
```

Задать (подставьте свой пароль БД):

- `DB_HOST` = `127.0.0.1`
- `DB_USER` = `plan_user`
- `DB_PASS` = ваш пароль (тот, что задавали при CREATE USER)

Сохранить (Ctrl+O, Enter, Ctrl+X).

### 3. Импорт БД (если ещё не делали)

Файл дампа должен быть на сервере (например в /root/dbs_backup.sql). Тогда:

```bash
mysql -u plan_user -p < /root/dbs_backup.sql
```

### 4. Права на файлы

```bash
chown -R www-data:www-data /var/www/html
```

### 5. Веб-сервер и PHP

Должны быть установлены Nginx (или Apache), PHP 7.4/8.x с расширениями mysql, mbstring, json, и MariaDB/MySQL. Document root — `/var/www/html`, в нём должен открываться index.php.

### 6. Если страницы выдают ошибку подключения к БД

- Проверьте, что env.php создан и в нём верные DB_USER и DB_PASS.
- Убедитесь, что пользователь plan_user создан и ему выданы права на базы auth, plan, plan_u3, plan_u4, plan_u5 (имена баз в lowercase на Linux).

Временный обходной путь: на сервере в MySQL выполнить:

```sql
CREATE USER 'root'@'localhost' IDENTIFIED BY '';
GRANT ALL ON *.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
```

Тогда скрипты с захардкоженным root/пустой пароль тоже смогут подключаться (использовать только для проверки, затем удалить такого root или сменить пароль).
