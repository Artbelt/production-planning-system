# Миграция поля аналога для У3

## Описание изменений

Механизм определения аналога для У3 переработан:
- **Было**: аналог хранился в поле `comment` в формате `ANALOG_FILTER=название_фильтра`
- **Стало**: аналог хранится в отдельном поле `analog` в таблице `round_filter_structure`

## Порядок выполнения миграции

### Шаг 1: Добавление поля в БД

Выполните SQL-скрипт для добавления поля `analog`:

```bash
mysql -u ваш_пользователь -p ваша_база_данных < add_analog_field.sql
```

Или выполните SQL-запрос вручную:
```sql
ALTER TABLE `round_filter_structure` 
ADD COLUMN `analog` VARCHAR(255) NULL DEFAULT NULL COMMENT 'Аналог фильтра' AFTER `comment`;
```

### Шаг 2: Миграция существующих данных

Запустите скрипт миграции данных:

```bash
php migrate_analog_from_comment.php
```

Этот скрипт:
- Найдет все записи, где в `comment` есть `ANALOG_FILTER=...`
- Извлечет значение аналога
- Сохранит его в поле `analog`
- Удалит `ANALOG_FILTER=...` из поля `comment`

### Шаг 3: Проверка

После миграции проверьте:
1. Что поле `analog` добавлено в таблицу
2. Что данные успешно мигрированы
3. Что форма редактирования фильтров работает корректно

## Изменения в коде

### Обновленные файлы:

1. **processing_add_round_filter_into_db.php**
   - Теперь сохраняет аналог в поле `analog` вместо добавления в `comment`
   - Поддерживает обратную совместимость (извлекает аналог из `comment`, если он там есть)

2. **edit_filter_properties.php**
   - Добавлено отдельное поле для ввода аналога
   - Аналог больше не добавляется в `comment`

3. **tools/tools.php** (функция `get_filter_data()`)
   - Читает аналог из поля `analog`
   - Поддерживает обратную совместимость (читает из `comment`, если `analog` пусто)

## Обратная совместимость

Код поддерживает обратную совместимость:
- При чтении: если поле `analog` пустое, пытается извлечь аналог из `comment`
- При сохранении: если аналог передан в старом формате (в `remark`), извлекает его и сохраняет в `analog`

## Примечания

- Поле `comment` теперь используется только для обычных комментариев
- Поле `analog` предназначено исключительно для хранения аналога фильтра
- После миграции рекомендуется удалить все упоминания `ANALOG_FILTER=` из поля `comment` вручную (если они остались)



