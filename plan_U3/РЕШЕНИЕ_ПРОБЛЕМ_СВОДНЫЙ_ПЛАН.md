# Решение проблем: Сводный план пустой

## Проблема: "Сводный план пуст"

Если при открытии страницы **Сводный план У3** вы видите сообщение "Нет плана на эту неделю", это означает, что в таблице `build_plans` нет данных для текущей недели.

## Диагностика

### Шаг 1: Включите режим отладки
Добавьте `?debug=1` к URL страницы:
```
summary_plan_U3.php?debug=1
```

Вы увидите:
- **Период** — диапазон дат текущей недели
- **Активных заявок** — количество незавершённых заявок в системе
- **Записей в плане** — количество записей в таблице `build_plans` для этой недели

### Шаг 2: Анализ результатов

#### Вариант A: Активных заявок = 0
**Причина:** В системе нет активных (незавершённых) заявок.

**Решение:**
1. Создайте новую заявку через кнопку **"➕ Новая заявка"**
2. Или проверьте, не скрыты ли заявки (поле `hide = 1` в таблице `orders`)

#### Вариант B: Активных заявок > 0, но записей в плане = 0
**Причина:** План сборки не создан для текущей недели.

**Решение:**
1. Перейдите на страницу **"План сборки"** (`NP_build_plan.php`)
2. Выберите заявку из списка
3. Распределите позиции по дням недели
4. Сохраните план

#### Вариант C: Записей в плане > 0, но они не отображаются
**Причина:** Записи в плане относятся к другой неделе.

**Решение:**
1. Используйте кнопки навигации: **"◀ Неделя назад"** / **"Неделя вперед ▶"**
2. Или проверьте даты в таблице `build_plans` — они должны попадать в диапазон текущей недели

## Как создать план сборки

### Метод 1: Через страницу "План сборки" (NP_build_plan.php)

1. Откройте страницу `NP_build_plan.php`
2. Выберите заявку из выпадающего списка
3. Вы увидите список позиций (фильтров) из заявки
4. Для каждой позиции укажите количество по дням
5. Кликайте по ячейкам дней:
   - **ЛКМ** — добавить 50 шт (или остаток)
   - **Ctrl+ЛКМ** или **ПКМ** — убавить 50 шт
6. Нажмите кнопку **"Сохранить план"**

### Метод 2: Через SQL (для разработчиков)

```sql
-- Вставка записи в план сборки
INSERT INTO build_plans (order_number, filter, day_date, shift, qty)
VALUES ('24-123', 'AF0167pe', '2024-11-11', 'D', 100);
```

Где:
- `order_number` — номер заявки
- `filter` — название фильтра
- `day_date` — дата (формат YYYY-MM-DD)
- `shift` — смена ('D' = дневная, 'N' = ночная)
- `qty` — количество

## Структура таблицы build_plans

```sql
CREATE TABLE IF NOT EXISTS build_plans (
    id            BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    order_number  VARCHAR(64) NOT NULL,
    filter        VARCHAR(128) NOT NULL,
    day_date      DATE NOT NULL,
    shift         ENUM('D','N') NOT NULL,
    qty           INT NOT NULL,
    saved_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY(id),
    KEY idx_order_date (order_number, day_date),
    KEY idx_order_filter (order_number, filter)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## Частые вопросы

### Почему план не отображается для прошлой/будущей недели?
**Ответ:** Сводный план показывает данные только для выбранной недели. Используйте кнопки навигации для перемещения между неделями.

### Позиции отображаются, но без факта производства
**Ответ:** Это нормально, если производство ещё не началось. Факт берётся из таблицы `manufactured_production` и обновляется после регистрации выпуска продукции.

### В отладке видны заявки, но план всё равно пустой
**Ответ:** Проверьте:
1. Есть ли записи в `build_plans` для этих заявок?
2. Попадают ли даты в `build_plans` в текущую неделю?
3. Совпадают ли номера заявок в `orders` и `build_plans`?

### Как проверить данные в базе?

```sql
-- Проверить активные заявки
SELECT order_number, filter, count, hide 
FROM orders 
WHERE hide = 0;

-- Проверить план на текущую неделю
SELECT * 
FROM build_plans 
WHERE day_date BETWEEN '2024-11-11' AND '2024-11-17'
ORDER BY day_date, order_number;

-- Проверить факт производства
SELECT name_of_order, name_of_filter, date_of_production, count_of_filters
FROM manufactured_production
WHERE date_of_production >= '2024-11-11'
ORDER BY date_of_production DESC;
```

## Контрольный список

- [ ] Есть активные заявки (проверить через режим отладки)
- [ ] Создан план сборки через `NP_build_plan.php`
- [ ] Даты в плане соответствуют текущей/нужной неделе
- [ ] Поле `hide = 0` для заявок в таблице `orders`
- [ ] Номера заявок в `build_plans` совпадают с номерами в `orders`

## Быстрая помощь

1. **Открыть с отладкой:** `/plan_U3/summary_plan_U3.php?debug=1`
2. **Создать план:** `/plan_U3/NP_build_plan.php`
3. **Новая заявка:** `/plan_U3/new_order.php`
4. **Главная У3:** `/plan_U3/main.php`

---

**Дата обновления:** 10.11.2024  
**Версия:** 1.1






















